function IS_OPERATOR(char){return char==SYMBOL_AND||char==SYMBOL_OR||char==SYMBOL_IMPL||char==SYMBOL_EQUAL||char==SYMBOL_NEG}function HAS_OPERATOR(text){for(var i=0;i<text.length;i++){var char=text.charAt(i);if(IS_OPERATOR(char))return!0}return!1}function GET_DN_SYMBOL(number){for(var s=""+number,rs="",i=0;i<s.length;i++){var idx=s.charAt(i);rs+=DNR[idx]}return rs}function DEBUG_NODE(node){null!=node&&(console.log("====DEBUG: "+node.value+"========"),console.log(node),console.log("isLeaf: "+node.isLeaf()),console.log("isGroup: "+node.isGroup()),console.log("isClips: "+node.isClips()),console.log("====END DEBUG============="))}function REX(re,text){var match=re.exec(text);console.log(match)}const SYMBOL_OR="∨",SYMBOL_AND="∧",SYMBOL_NEG="¬",SYMBOL_IMPL="⇒",SYMBOL_EQUAL="⇔",DN_NR=["₀","₁","₂","₃","₄","₅","₆","₇","₈","₉"],DNR={0:"₀",1:"₁",2:"₂",3:"₃",4:"₄",5:"₅",6:"₆",7:"₇",8:"₈",9:"₉"},UP_NR=["⁰","¹","²","³","⁴","⁵","⁶","⁷","⁸","⁹"],KEY_LEFT=37,KEY_RIGHT=39,KEY_UP=38,KEY_DOWN=40,KEY_BACKSPACE=8,KEY_SPACE=32,KEY_A=65,KEY_G=71,KEY_K=75,KEY_Z=90,KEY_NUM_0=96,KEY_NUM_1=97,KEY_0=48,KEY_1=49,KEY_2=50,KEY_3=51,KEY_4=52,KEY_5=53,KEY_6=54,KEY_7=55,KEY_8=56,KEY_9=57,KEY_PLUS=187,KEY_COMMA=188,KEY_LINE=189,KEY_DOT=190,KEY_SHARP=191,KEY_CONTROL=17;DomUtils={getCaretPosition:function(editableDiv){var sel,range,caretPos=0;if(window.getSelection)sel=window.getSelection(),sel.rangeCount&&(range=sel.getRangeAt(0),range.commonAncestorContainer.parentNode==editableDiv&&(caretPos=range.endOffset));else if(document.selection&&document.selection.createRange&&(range=document.selection.createRange(),range.parentElement()==editableDiv)){var tempEl=document.createElement("span");editableDiv.insertBefore(tempEl,editableDiv.firstChild);var tempRange=range.duplicate();tempRange.moveToElementText(tempEl),tempRange.setEndPoint("EndToEnd",range),caretPos=tempRange.text.length}return caretPos},insertTextAtCursor:function(text){var sel,range;window.getSelection?(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount&&(range=sel.getRangeAt(0),range.deleteContents(),range.insertNode(document.createTextNode(text)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=text)},pasteHtmlAtCaret:function(html,node){var sel,range;if(window.getSelection){if(sel=window.getSelection(),sel.getRangeAt&&sel.rangeCount){if(range=sel.getRangeAt(0),node&&(range.startContainer.id!=node.id||range.endContainer.id!=node.id||range.startContainer.className!=node.className||range.endContainer.className!=node.className))return!1;range.deleteContents();var el=document.createElement("div");el.innerHTML=html;for(var node,lastNode,frag=document.createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);if(lastNode==node)return;range.insertNode(frag),lastNode&&(range=range.cloneRange(),range.setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(html)},saveSelection:function(){if(window.getSelection){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount)return sel.getRangeAt(0)}else if(document.selection&&document.selection.createRange)return document.selection.createRange();return null},restoreSelection:function(range){if(range)if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}else document.selection&&range.select&&range.select()},getSelectionStart:function(){return document.getSelection().getStartElement()},getCaretCharacterOffsetWithin:function(element){var sel,caretOffset=0,doc=element.ownerDocument||element.document,win=doc.defaultView||doc.parentWindow;if("undefined"!=typeof win.getSelection){if(sel=win.getSelection(),sel.rangeCount>0){var range=win.getSelection().getRangeAt(0),preCaretRange=range.cloneRange();preCaretRange.selectNodeContents(element),preCaretRange.setEnd(range.endContainer,range.endOffset),caretOffset=preCaretRange.toString().length}}else if((sel=doc.selection)&&"Control"!=sel.type){var textRange=sel.createRange(),preCaretTextRange=doc.body.createTextRange();preCaretTextRange.moveToElementText(element),preCaretTextRange.setEndPoint("EndToEnd",textRange),caretOffset=preCaretTextRange.text.length}return caretOffset},setCaretPosition:function(element,offset){for(var range=document.createRange(),sel=window.getSelection(),currentNode=null,previousNode=null,i=0;i<element.childNodes.length;i++){for(previousNode=currentNode,currentNode=element.childNodes[i];currentNode.childNodes.length>0;)currentNode=currentNode.childNodes[0];if(currentNode&&null!=previousNode&&(offset-=previousNode.length),offset<=currentNode.length)break}if(null!=currentNode){currentNode.length<offset&&offset--;try{return range.setStart(currentNode,offset),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range),!0}catch(e){}}return!1},getSelectedText:function(withHtml){var html="";if("undefined"!=typeof window.getSelection){var sel=window.getSelection();if(sel.rangeCount){for(var container=document.createElement("div"),i=0,len=sel.rangeCount;i<len;++i)container.appendChild(sel.getRangeAt(i).cloneContents());html=withHtml?container.innerHTML:container.innerText}}else"undefined"!=typeof document.selection&&"Text"==document.selection.type&&(html=withHtml?document.selection.createRange().htmlText:document.selection.createRange().text);return html}},String.prototype.replaceAll=function(search,replacement){var target=this;return target.split(search).join(replacement)},Array.prototype.merge=function(A){if(Array.isArray(A))for(var i=0;i<A.length;i++){var a=A[i];this.indexOf(a)<0&&this.push(a)}else this.indexOf(A)<0&&this.push(A)},Array.prototype.contains=function(obj){for(var i=0;i<this.length;i++)if(this[i]===obj)return!0;return!1},Array.prototype.clear=function(){0!=this.length&&this.splice(0,this.length)},String.prototype.countChar=function(char){if(0==this.length)return 0;for(var count=0,i=0;i<this.length;i++){var ch=this.charAt(i);ch==char&&count++}return count};var CanvasInterface={createEasel:function(id){var canvas=document.getElementById(id),hoverOverlay=null;if("CANVAS"!=canvas.tagName){var c=document.createElement("CANVAS"),cName=id+"_canvas";c.setAttribute("id",cName),canvas.appendChild(c),canvas=c,id=cName}const labelColor="#333";var stage=new createjs.Stage(id);stage.name="stage",stage.enableMouseOver(20);var colorContainer=new createjs.Container;colorContainer.name="colorContainer",colorContainer.x=colorContainer.y=0;var blockContainer=new createjs.Container;return blockContainer.name="blockContainer",blockContainer.x=blockContainer.y=0,stage.addChild(blockContainer),stage.addChild(colorContainer),canvas.clearColorContainer=function(){colorContainer.removeAllChildren()},canvas.addToColorContainer=function(color,x,y,width,height){var rect=new createjs.Shape;rect.x=x,rect.y=y,rect.alpha=.5,rect.graphics.beginFill(color).drawRoundRect(0,0,width,height,5).endFill(),colorContainer.addChild(rect)},canvas.add=function(block){var label=new createjs.Text(block.value,"20px Arial",labelColor);label.colors={normal:labelColor,error:"red"},label.textAlign="center",label.textBaseline="middle",label.x=block.width/2,label.y=block.height/2;var button=new createjs.Container;if(button.name="block_"+block.x+"_"+block.y,button.x=block.x,button.y=block.y,block.ui={label:label,button:button},block.cell){var bg=new createjs.Shape;bg.overColor="#ddd",bg.outColor="white",bg.graphics.beginFill(bg.outColor).beginStroke("black").drawRect(0,0,block.width,block.height),button.addChild(bg),button.addEventListener("click",function(evt){canvas.onBlockClick({event:evt,block:block,label:label,button:button,background:bg})}),button.addEventListener("mouseover",function(evt){hoverOverlay._fill||bg.graphics.clear().beginFill(bg.overColor).drawRect(0,0,block.width,block.height).endFill().beginStroke("black").drawRect(0,0,block.width,block.height),canvas.onBlockHover({event:evt,block:block,label:label,button:button,background:bg})}),button.addEventListener("mouseout",function(evt){hoverOverlay._fill||bg.graphics.clear().beginFill(bg.outColor).drawRect(0,0,block.width,block.height).endFill().beginStroke("black").drawRect(0,0,block.width,block.height),canvas.onBlockOut({event:evt,block:block,label:label,button:button,background:bg})}),block.ui.bg=bg}button.addChild(label),blockContainer.addChild(button)},canvas.placeOverlay=function(block,color){var overlay=new createjs.Shape;overlay.alpha=.35,overlay.graphics.beginFill(color).drawRoundRect(8,8,16,16).endFill(),overlay.x=block.x,overlay.y=block.y,stage.addChild(overlay)},canvas.createHoverOverlay=function(){null==hoverOverlay&&(hoverOverlay=new createjs.Shape,hoverOverlay.alpha=.35,hoverOverlay.x=0,hoverOverlay.y=0,hoverOverlay._fill=null,canvas.setHoverOverlayStyle(null),stage.addChild(hoverOverlay))},canvas.setHoverOverlayStyle=function(fill){hoverOverlay._fill=fill,null==fill&&(fill="transparent"),canvas.createHoverOverlay(),hoverOverlay.graphics.clear().beginFill(fill).drawRect(8,8,16,16).endFill(),canvas.refresh()},canvas.setHoverOverlayPosition=function(x,y){canvas.createHoverOverlay(),hoverOverlay.x=x,hoverOverlay.y=y},canvas.clearChildren=function(){hoverOverlay=null,blockContainer.removeAllChildren()},canvas.onBlockHover=function(block){},canvas.onBlockClick=function(block){},canvas.setSize=function(width,height){stage.canvas.width=width,stage.canvas.height=height},canvas.refresh=function(force){stage.update()},canvas},createPixi:function(id){var renderer=PIXI.autoDetectRenderer(1,1,{backgroundColor:16119285}),container=document.getElementById(id);container.appendChild(renderer.view),renderer.view.backgroundColor=16119285;var stage=new PIXI.Container,testText=new PIXI.Text("TEST");return testText.x=32,testText.y=32,stage.addChild(testText),{setSize:function(width,height){renderer.view.width=width,renderer.view.height=height},clearChildren:function(){},add:function(){},refresh:function(){}}},createSvg:function(id){const NS="http://www.w3.org/2000/svg";var svg=document.getElementById(id);if("SVG"!=svg.tagName){var c=document.createElementNS(NS,"svg"),cName=id+"_svg";c.setAttribute("id",cName),svg.appendChild(c),svg=c,id=cName}return svg.add=function(block){var rect=document.createElementNS(NS,"rect");rect.setAttribute("x",block.x),rect.setAttribute("y",block.y),rect.setAttribute("width",block.width),rect.setAttribute("height",block.height);var fill=block.cell?"fill:white;stroke-width:1;stroke:black;":"fill:transparent;stroke-width:0;";rect.setAttribute("style",fill);var text=document.createElementNS(NS,"text");text.setAttribute("x","0"),text.setAttribute("y","0"),text.setAttribute("fill","black");var textNode=document.createTextNode(block.value);text.appendChild(textNode),rect.appendChild(text),svg.appendChild(rect)},svg.setSize=function(width,height){svg.setAttribute("width",width),svg.setAttribute("height",height)},svg.clearChildren=function(){for(;svg.firstChild;)svg.removeChild(svg.firstChild)},svg.refresh=function(){},svg},createPlainCanvas:function(id){var canvas=document.getElementById(id);if("CANVAS"!=canvas.tagName){var c=document.createElement("CANVAS"),cName=id+"_canvas";c.setAttribute("id",cName),canvas.appendChild(c),canvas=c,id=cName}var ctx=canvas.getContext("2d");ctx.sRect=function(x,y,w,h){x=parseInt(x)+.5,y=parseInt(y)+.5,this.strokeRect(x,y,w,h)},ctx.fRect=function(x,y,w,h){x=parseInt(x),y=parseInt(y),this.fillRect(x,y,w,h)},canvas.isDirty=!1;const blockHover="#ddd";var lastBlock=null,blocks=[],isOver=function(block){block.cell&&(block!=lastBlock&&loseHover(block),block.fill!=blockHover&&(canvas.isDirty=!0),block.fill=blockHover,lastBlock=block)},loseHover=function(block){block.cell&&("white"!=block.fill&&(canvas.isDirty=!0),block.fill="white")};return canvas.addEventListener("mousemove",function(e){for(var mouse={x:e.offsetX,y:e.offsetY},i=0;i<blocks.length;i++){var block=blocks[i];loseHover(block),block.isInside(mouse)&&isOver(block)}canvas.refresh()}),canvas.addEventListener("click",function(e){for(var mouse={x:e.offsetX,y:e.offsetY},i=0;i<blocks.length;i++){var block=blocks[i];block.isInside(mouse)&&canvas.onBlockClick(block)}}),canvas.add=function(block){blocks.push(block)},canvas.clearChildren=function(){blocks=[]},canvas.onBlockHover=function(block){},canvas.onBlockClick=function(block){},canvas.setSize=function(width,height){canvas.width=width,canvas.height=height},canvas.clear=function(){ctx.clearRect(0,0,canvas.width,canvas.height)},canvas.refresh=function(force){if(canvas.isDirty||force){canvas.clear();for(var i=0;i<blocks.length;i++){var block=blocks[i];block.draw(ctx)}}},canvas}},BADomain=function(name){this.table=null,this.expression=null,this.getTree=function(){return this.expression.rootNode}},BAGroup=function(text){this.expression=new BAExpression(text),this.key=BAGroup.getNextGroupIndex(text),this.number=BAGroup.groupIndex-1,this.expression.groupKey=this.key,this.isValid=function(){return this.expression.isValid()},this.getHtml=function(){return this.expression.getHtml()},this.getText=function(){return this.expression.text}};BAGroup.groups=[],BAGroup.groupIndex=1,BAGroup.getNextGroupIndex=function(text){for(var i=0;i<BAGroup.groups.length;i++){var group=BAGroup.groups[i];if(group.text==text)return group.key}return"G"+BAGroup.groupIndex++},BAGroup.get=function(key){var vKey=key.replace(SYMBOL_NEG,"");if(vKey.length<2)return null;for(var i=0;i<BAGroup.groups.length;i++){var group=BAGroup.groups[i];if(vKey==group.key)return group}return null},BAGroup.add=function(group){BAGroup.groups.push(group)},BAGroup.useGroup=function(mainExpr,group){mainExpr.useGroup(group);for(var i=0;i<BAGroup.groups.length;i++){var g=BAGroup.groups[i];g.key!=group.key&&g.expression.useGroup(group)}};var BANode=function(params){this.value=params?params.value:null,this.child1=params?params.child1:null,this.child2=params?params.child2:null,this.parent=params?params.parent:null,this.clipInfo=!!params&&params.clipInfo,this.parent=null,this.group=params?params.group:null,this.isClips=function(){return null!=this.clipInfo},this.isValid=function(){return this.child2&&this.child1},this.isRoot=function(){return null==this.parent},this.findChild=function(value){if(this.value==value)return this;var child=this.child2?this.child2.findChild(value):null;return null!=child?child:this.child1?this.child1.findChild(value):null},this.getHtml=function(){var value=this.value;if(this.isLeaf())value='<span class="expr">'+value+"</span>";else if(!this.isRoot()&&this.isGroup()||this.isRoot()&&this.isGroup()&&!this.child1&&!this.child2)value='<span class="expr group">'+value+"</span>";else{var childA=this.child1&&""!=this.child1.value?this.child1.getHtml():"",childB=this.child2&&""!=this.child2.value?this.child2.getHtml():"",Class="";Class=value==SYMBOL_NEG?"neg":IS_OPERATOR(value)?"op":"expr",value=childA+'<span class="'+Class+'">'+value+"</span>"+childB}return this.isClips()&&(value='<span class="clips">(</span>'+this.clipInfo.rootNode.getHtml()+'<span class="clips">)</span>'),value},this.isGroup=function(){return null!=this.group},this.isLeaf=function(){return!(this.isGroup()||this.child2&&null!=this.child2&&this.child1&&null!=this.child1)},this.getLetters=function(){var letters=[];return""==this.value?letters:(this.isClips()&&this.clipInfo.rootNode?letters.merge(this.clipInfo.rootNode.getLetters()):!this.isGroup()||this.child1||this.child2?this.isLeaf()?letters.merge(this.value):(letters.merge(this.child1.getLetters()),letters.merge(this.child2.getLetters())):letters.merge(this.group.expression.rootNode.getLetters()),letters)},this.getResult=function(param){var result=0;if(!this.isGroup()||this.child2||this.child1)if(this.isClips())result=this.clipInfo.rootNode.getResult(param);else if(IS_OPERATOR(this.value)){var childA=this.child1.getResult(param),childB=this.child2.getResult(param);switch(""==this.child1.value?result=childB:""==this.child2.value&&(result=childA),this.value){case SYMBOL_AND:result=1==childA&&1==childB;break;case SYMBOL_OR:result=1==childA||1==childB;break;case SYMBOL_IMPL:result=1-childA==1||1==childB;break;case SYMBOL_EQUAL:result=childA==childB;break;case SYMBOL_NEG:result=1-result}}else for(var key in param)param.hasOwnProperty(key)&&key==this.value&&(result=Number(param[key]));else result=this.group.expression.rootNode.getResult(param);return result?1:0}},BATable=function(rootNode){this.letters=[],this.groups=BAGroup.groups,this.bits=[],this.isLoading=!1;this.build=function(node){this.isLoading=!0,this.letters.clear(),this.letters=node.getLetters(),this.isLoading=!1},this.build(rootNode),this.updateView=function(){this.isLoading=!0,this.bits.clear();for(var lettersCount=this.letters.length,max=Math.pow(2,lettersCount),l=0;l<max;l++){for(var bitLine={letters:[],groups:[],clips:[]},lTemp=l,valueObject={},i=lettersCount-1;i>=0;i--){var letter=this.letters[lettersCount-1-i],v=0,vTemp=Math.pow(2,i);lTemp>=vTemp&&(lTemp-=vTemp,v=1),bitLine.letters.push({value:v}),valueObject[letter]=v}bitLine.param=valueObject,bitLine.result={},this.bits.push(bitLine)}this.isLoading=!1}},BAExpression=function(text){var $this=this;this.rootNode=null,this.text="",this.errors=[],this.clips=[];var priorSplit=[SYMBOL_EQUAL,SYMBOL_IMPL,SYMBOL_OR,SYMBOL_AND,SYMBOL_NEG],pushError=function(data){$this.errors.push(data)},clearErrors=function(){$this.errors.length=0},getClipByRaw=function(raw){for(var i=0;i<$this.clips.length;i++){var c=$this.clips[i];if(raw==c.raw)return c}return null},getClips=function(text){for(var re=BAExpression.regex.clips,found=0,count=0;null!==(match=re.exec(text));){if(count++>=99999)return!1;var m=match[0],clip=getClipByRaw(m);if(found++,null==clip){var mInside=m.substr(1,m.length-2),key="["+$this.clips.length+"]";clip={key:key,text:mInside,raw:m,start:match.index,end:re.lastIndex-1},$this.clips.push(clip)}}var output=text;if(found>0){for(var i=0;i<$this.clips.length;i++)clip=$this.clips[i],output=output.replaceAll(clip.raw,clip.key);var clipInfo=getClips(output);output=clipInfo.output}return{input:text,output:output}},splitByOperator=function(text){for(var i=0;i<priorSplit.length;i++){var pS=priorSplit[i],index=text.indexOf(pS);if(index>-1){var sideA=text.substring(0,index),sideB=text.substring(index+1,text.length);return{a:sideA,b:sideB,value:pS}}}return{a:null,b:null,value:text}},getClipInfo=function(key){if(key.length<3)return null;for(var i=0;i<$this.clips.length;i++){var clip=$this.clips[i];if(clip.key==key)return clip}return null};this.buildTree=function(text){if(null==text)return null;var splitInfo=splitByOperator(text),node=new BANode({value:splitInfo.value,child1:this.buildTree(splitInfo.a),child2:this.buildTree(splitInfo.b)});if(node.isLeaf()&&""!=node.value){var group=BAGroup.get(text),clip=getClipInfo(text);clip&&(clip.rootNode=this.buildTree(clip.text)),node.group=group,node.clipInfo=clip}return node.child1&&(node.child1.parent=node),node.child2&&(node.child2.parent=node),node},this.findChild=function(value){return this.rootNode.findChild(value)};var matchError=function(text){var tmpChar=text.charAt(0);tmpChar!=SYMBOL_NEG&&IS_OPERATOR(tmpChar)&&pushError({index:0,value:tmpChar,text:"Syntaxerror: "+tmpChar+" at 0"});var idX=text.length-1;tmpChar=text.charAt(idX),IS_OPERATOR(tmpChar)&&pushError({index:idX,value:tmpChar,text:"Syntaxerror: "+tmpChar+" at "+idX});for(var match,re=BAExpression.regex.error;null!==(match=re.exec(text));){var val=match[0];pushError({index:match.index,value:val,text:"Syntaxerror: "+val+" at "+match.index})}for(var clipStack=[],i=0;i<text.length;i++){var C=text.charAt(i);if("("==C||")"==C)if(0==clipStack.length){if(clipStack.push({"char":C,index:i}),")"==C)break}else{var L=clipStack[0];C==L["char"]?clipStack.push({"char":C,index:i}):clipStack.splice(0,1)}}if(clipStack.length>0){var c=clipStack[0];pushError({index:c.index,value:c["char"],text:"Syntaxerror "})}},hasErrors=function(text){return clearErrors(),matchError(text),$this.errors.length>0};this.parse=function(text){if(text=text.replaceAll(" ","").toUpperCase(),this.text=text,!hasErrors(text)){$this.clips.length=0;var clipInfo=getClips(text);this.rootNode=this.buildTree(clipInfo.output)}},text&&this.parse(text),this.isValid=function(){return 0==$this.errors.length},this.getText=function(){return this.text},this.getHtmlWithError=function(){var error=$this.errors[0],bText=this.text.substr(0,error.index),text=this.text.charAt(error.index),aText=this.text.substr(error.index+1);return(""!=bText?"<span>"+bText+"</span>":"")+(""!=text?'<span class="error" title="'+error.text+'">'+text+"</span>":"")+(""!=aText?"<span>"+aText+"</span>":"")},this.getHtml=function(){return this.isValid()?this.rootNode?this.rootNode.getHtml():"":this.getHtmlWithError()},this.groupFilter=function(group){return this.text.replaceAll(group.getText(),group.key)},this.getResult=function(param){return this.rootNode.getResult(param)},this.useGroup=function(group){var text=this.groupFilter(group);return text!=this.text&&(this.parse(text),this.updateInput(),!0)},this.unuseGroup=function(group){var text=this.text.replaceAll(group.key,group.getText());return text!=this.text&&(this.parse(text),this.updateInput(),!0)},this.updateInput=function(){this.$input&&this.$input.html(this.getHtml())},this.useAllGroups=function(){if(null==this.rootNode||this.rootNode.isGroup())return!1;for(var i=0;i<BAGroup.groups.length;i++){var g=BAGroup.groups[i];BAGroup.useGroup(this,g)}}};BAExpression.regex={clips:/\([0|1|A-Z0-9|∨|∧|¬|⇒|⇔|\[\]]+\)/g,clipname:/([?[1-9]+]?)+/g,error:/[A-Za-z0-9]+\(+|\)([A-Za-z0-9]+|¬)|[0-9][A-Za-z]+|¬+(∨|∧|⇒|⇔)|(∨|∧|⇒|⇔)+(∨|∧|⇒|⇔)+|\(\)|\)\(|(∨|∧|⇒|⇔)+\)+|([A-Za-z]+¬+)/g,syntax:/(¬*([((A-Za-z)(1-9)*)|1|0])(∧|∨)?)*/g},BAExpression.validSyntax=function(text){var forbChar=function(char){return char==SYMBOL_AND||char==SYMBOL_OR||char==SYMBOL_IMPL};return!(forbChar(text.charAt(0))||forbChar(text.charAt(text.length-1)))};var KVDiagram=function(){this.field=[];var width=0;this.getWidth=function(){return width},this.getHeight=function(){return this.field.length},this.getRow=function(index){return this.field[index]};var reflectV=function(A){for(var reflField=[],r=A.length-1;r>=0;r--){var row=A[r];reflField.push(row.clone())}return A.concat(reflField)},reflectH=function(A){for(var r=0;r<A.length;r++){for(var mirror=[],row=A[r],c=row.getLength()-1;c>=0;c--){var col=row.getCol(c);mirror.push(col.clone())}row.appendCols(mirror)}return A};this.reflectHorizontal=function(Var){if(this.field.length<1){var newRow=new KVRow;newRow.addCol(new KVCol(0)),newRow.addCol(new KVCol(0)),this.field.push(newRow)}else this.field=reflectH(this.field);width=this.field[0].getLength();for(var half=width/2,i=0;i<this.field.length;i++)for(var row=this.field[i],j=0;j<half;j++){var colA=row.getCol(j),colB=row.getCol(half+j);colA.addVar(Var),colB.addVar(SYMBOL_NEG+Var)}},this.reflectVertical=function(Var){if(this.field.length<2){var row=this.field[0].clone();this.field.push(row)}else this.field=reflectV(this.field);for(var half=this.getHeight()/2,i=0;i<half;i++)for(var rowA=this.field[i],rowB=this.field[half+i],j=0;j<rowA.getLength();j++)rowA.getCol(j).addVar(Var),rowB.getCol(j).addVar(SYMBOL_NEG+Var)}},KVCol=function(value,Var){this.value=value||0,this.assignedVars=Var?Array.isArray(Var)?Var:[Var]:[],this.colors=[],this.addVar=function(char){this.assignedVars.push(char)},this.addColor=function(color){this.colors.indexOf(color)<0&&this.colors.push(color)},this.removeColor=function(color){var idx=this.colors.indexOf(color);idx>=0&&this.colors.splice(idx,1)},this.toggleColor=function(color){this.colors.indexOf(color)<0?this.addColor(color):this.removeColor(color)},this.clone=function(){for(var vars=[],i=0;i<this.assignedVars.length;i++)vars.push(this.assignedVars[i]);return new KVCol(this.value,vars)}},KVRow=function(){this.cols=[],this.addCol=function(col){this.cols.push(col)},this.appendCols=function(A){this.cols=this.cols.concat(A)},this.getCol=function(index){return this.cols[index]},this.getLength=function(){return this.cols.length},this.clone=function(){for(var row=new KVRow,i=0;i<this.cols.length;i++)row.addCol(this.cols[i].clone());return row}},KVBlock=function(x,y,width,height,value){this.x=x||0,this.y=y||0,this.width=width||0,this.height=height||0,this.value=value||0,this.cell=null,this.fill="white",this.setValue=function(val){this.value=val,this.cell&&(this.cell.value=val)},this.addColor=function(color){this.cell&&this.cell.addColor(color)},this.removeColor=function(color){this.cell&&this.cell.removeColor(color)},this.toggleColor=function(color){this.cell&&this.cell.toggleColor(color)},this.getValue=function(){return this.cell?this.cell.value:this.value},this.getText=function(){return this.value||"0"},this.isInside=function(p){return p.x>=this.x&&p.x<this.x+this.width&&p.y>=this.y&&p.y<this.y+this.height},this.draw=function(ctx){ctx.fillStyle=this.cell?this.fill:"transparent",ctx.fRect(x,y,width,height),ctx.beginPath(),ctx.strokeStyle=this.cell?"black":"transparent",ctx.sRect(x,y,width,height),ctx.fillStyle="black",ctx.textAlign="center",ctx.textBaseline="middle",ctx.font=this.cell?"30px Verdana":"18px Verdana",ctx.fillText(value+"",x+width/2,y+height/2)},this.getRenderObject=function(caption){return this}},ColorPath=function(ownerCell,color){this.color=color,this.ownerCell=ownerCell,this.push=function(cell){}},ColorPathMap=function(){var visitedCells=[];this.start=function(cell,color){if(color in visitedCells){if(visitedCells[color].contains(cell))return!1}else visitedCells[color]=[];visitedCells[color].push(cell);var path=new ColorPath(cell,color);next(cell.right,path)};var next=function(cell,path){if(cell.value!=path.ownerCell.value||cell.colors.contains(path.color))return!1}},BAKV=function(params){var $this=this;this.diagram=null,this.expr=params.expr||null;var size=32,canvas=null,vars=[],selectColor=null,blocks=[],generateBlockColors=function(){canvas.clearColorContainer();for(var colorMap=new ColorPathMap,i=0;i<blocks.length;i++)for(var cell=blocks[i].cell,j=0;j<cell.colors.length;j++)colorMap.start(cell,cell.colors[j])};this.setCanvas=function(target){canvas=CanvasInterface.createEasel(target),canvas.onBlockClick=function(parm){null!=selectColor?(parm.block.toggleColor(selectColor),generateBlockColors()):(parm.block.setValue(0==parm.block.getValue()?1:0),parm.label.text=parm.block.getValue(),parm.label.color=parm.label.colors.normal),canvas.refresh()},canvas.onBlockHover=function(parm){canvas.setHoverOverlayPosition(parm.block.x,parm.block.y),canvas.refresh()},canvas.onBlockOut=function(parm){canvas.refresh()}},this.setCanvas(params.target),this.setSelectColor=function(color){selectColor=color,canvas.setHoverOverlayStyle(color)},this.resizeCanvas=function(){var h=Math.ceil(vars.length/2),w=vars.length-h,canvasWidth=w*size+this.diagram.getWidth()*size+size,canvasHeight=h*size+this.diagram.getHeight()*size+size;canvas.setSize(canvasWidth,canvasHeight)};var generateBlocks=function(){var h=Math.ceil(vars.length/2),w=vars.length-h,gridOffset={x:size*w,y:size*h};canvas.clearChildren(),blocks=[];for(var r=0;r<$this.diagram.getHeight();r++){for(var block,aVar,row=$this.diagram.getRow(r),firstcol=row.cols[0],rI=1,offX=1;rI<firstcol.assignedVars.length;rI+=2,offX++)aVar=firstcol.assignedVars[rI],block=new KVBlock(gridOffset.x+offX*-size,gridOffset.y+r*size,size,size,aVar),canvas.add(block.getRenderObject(!0));for(var c=0;c<$this.diagram.getWidth();c++){var col=row.getCol(c);if(0==r)for(var cI=0,offY=1;cI<col.assignedVars.length;cI+=2,offY++)aVar=col.assignedVars[cI],block=new KVBlock(gridOffset.x+c*size,gridOffset.y+offY*-size,size,size,aVar),canvas.add(block.getRenderObject(!0));block=new KVBlock(gridOffset.x+c*size,gridOffset.y+r*size,size,size,col.value),block.cell=col,col.block=block,blocks.push(block),canvas.add(block.getRenderObject())}}canvas.createHoverOverlay(),canvas.refresh(!0)};this.checkResult=function(){for(var transformVar=function(A){for(var X={},i=0;i<A.length;i++){var a=A[i],val=1;a.charAt(0)==SYMBOL_NEG&&(val=0,a=a.substr(1,a.length-1)),X[a]=val}return X},i=0;i<blocks.length;i++){var block=blocks[i];block.V||(block.V=transformVar(block.cell.assignedVars)),block.result=$this.expr.getResult(block.V),block.ui.label.color=block.result==block.getValue()?block.ui.label.colors.normal:block.ui.label.colors.error,console.log(block.ui.label)}canvas.refresh()};var createNetwork=function(){for(var w=$this.diagram.getWidth(),w2=w-1,h=$this.diagram.getHeight(),L=w*h,L2=L-1,n=0;n<blocks.length;n++){var cell=blocks[n].cell;cell.n=n;var nMw=n%w,r=nMw==w2?n-w2:n+1;cell.right=blocks[r].cell;var l=0==nMw?n+w2:n-1;cell.left=blocks[l].cell;var b=n<=L2-w?n+w:n%h;cell.bottom=blocks[b].cell;var t=n<w?L-(w-n):n-w;cell.top=blocks[t].cell}};this.generateKV=function(V){V||(V=this.expr.rootNode.getLetters()),vars=V;for(var A=new KVDiagram,i=0;i<V.length;i++)i%2==0?A.reflectHorizontal(V[i]):A.reflectVertical(V[i]);this.diagram=A,this.resizeCanvas(),generateBlocks(),createNetwork()},this.refresh=function(){canvas.refresh()}};angular.module("boolean-algebra",["ngRoute","pascalprecht.translate","ngSanitize"]).config(function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:"/view/boolalg.html",controller:"BACtrl"}),$routeProvider.otherwise({redirectTo:"/"}),$locationProvider.html5Mode(!0)}).config(["$translateProvider",function($translateProvider){$translateProvider.useStaticFilesLoader({prefix:"translations/lang-",suffix:".json"}),$translateProvider.useSanitizeValueStrategy("escape"),$translateProvider.preferredLanguage("de_DE")}]);